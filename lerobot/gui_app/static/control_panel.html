<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LeRobot | Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  
  </head>

  <body> 
    <div class="container-fluid d-flex justify-content-center align-items-center mt-4">
        <h1>LeRobot Control Panel</h1>
    </div>

    <div class="container p-4">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item " role="presentation">
              <button class="nav-link active" id="teleop-tab" data-bs-toggle="tab" data-bs-target="#teleop-tab-pane" type="button" role="tab" aria-controls="teleop-tab-pane" aria-selected="true">Teleop</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="record-tab" data-bs-toggle="tab" data-bs-target="#record-tab-pane" type="button" role="tab" aria-controls="record-tab-pane" aria-selected="false">Record</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="replay-tab" data-bs-toggle="tab" data-bs-target="#replay-tab-pane" type="button" role="tab" aria-controls="replay-tab-pane" aria-selected="false">Replay</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="calibrate-tab" data-bs-toggle="tab" data-bs-target="#calibrate-tab-pane" type="button" role="tab" aria-controls="calibrate-tab-pane" aria-selected="false">Calibrate</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">

            <!-- teleop controls -->
            <div class="tab-pane fade show active" id="teleop-tab-pane" role="tabpanel" aria-labelledby="teleop-tab" tabindex="0">
                <div class="container">
                    <div class="row">
                        <div class="col-6">
                            <div class="container p-4">

                                <!-- teleop control buttons -->
                                <div class="card">
                                    <h5 class="card-header">Mode Controls</h5>
                                    <div class="card-body">
                                      <button class="btn btn-primary" id="startTeleopBtn">Start Teleop</button>
                                      <button class="btn btn-danger" id="stopBtn">Stop</button>

                                      <!-- toggle swtich -->
                                      <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
                                        <label class="form-check-label" for="flexSwitchCheckDefault">Display Info</label>
                                      </div>

                                    </div>
                                </div>

                                <!-- teleop configuration -->
                                <div class="accordion mt-lg-4" id="teleopAccordians">
                                  <div class="accordion-item">
                                    <h2 class="accordion-header">
                                      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        Mode Configurations
                                      </button>
                                    </h2>
                                    <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#teleopAccordians">
                                      <div class="accordion-body">
                                        <p class="card-text">Config parameters for robot teleop</p>

                                        <!-- configs -->
                                        <form id="teleopConfigForm" action="/telop/config-update" method="post">

                                          <div class="mb-3">
                                            <label for="robotConfigSelect" class="form-label">Robot Config File</label>
                                            <select id="robotConfigSelect" class="form-select" name="robot_config">
                                              <option>lerobot/configs/robot/koch.yaml</option>
                                              <option>lerobot/configs/robot/so100.yaml</option>
                                            </select>
                                          </div>

                                          <div class="row g-3 align-items-center mb-3">
                                            <div class="col-auto">
                                              <label for="teleopFPS" class="col-form-label">FPS</label>
                                            </div>
                                            <div class="col-auto">
                                              <input type="text" id="teleopFPS" name="fps" class="form-control" aria-describedby="teleopHelpInline" value=30>
                                            </div>
                                          </div>

                                          <button type="submit" class="btn btn-primary">Apply</button>
                                        </form>

                                      </div>
                                    </div>
                                  </div>
                                  
                                  <!-- log messages -->
                                  <div class="accordion-item">
                                    <h2 class="accordion-header">
                                      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLogs" aria-expanded="true" aria-controls="collapseLogs">
                                        Logs
                                      </button>
                                    </h2>
                                    <div id="collapseLogs" class="accordion-collapse collapse" data-bs-parent="#teleopAccordians">
                                      <div class="accordion-body" id="logsDisplay" style="overflow: scroll; max-height: 500px; font-size: 12px;"></div>
                                    </div>
                                  </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-6">
                            <div class="container p-4">
                                <div class="card">
                                    <div class="card-body">
                                      <!-- <h5 class="card-title">Card title</h5> -->
                                      <p class="card-text">cam name</p>
                                      <!-- <p class="card-text"><small class="text-body-secondary">Last updated 3 mins ago</small></p> -->
                                    </div>
                                    <img src="/video/0" class="card-img-bottom" alt="" style="width: 640px; height: 480px; background: #000; border-radius: 4px;">
                                </div>

                                <div class="card">
                                    <div class="card-body">
                                      <!-- <h5 class="card-title">Card title</h5> -->
                                      <p class="card-text">cam name</p>
                                      <!-- <p class="card-text"><small class="text-body-secondary">Last updated 3 mins ago</small></p> -->
                                    </div>
                                    <img src="https://plus.unsplash.com/premium_photo-1669357657874-34944fa0be68?q=80&w=3870&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" class="card-img-bottom" alt="">
                                </div>
                            </div>                            
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="record-tab-pane" role="tabpanel" aria-labelledby="record-tab" tabindex="0">...</div>
            <div class="tab-pane fade" id="replay-tab-pane" role="tabpanel" aria-labelledby="replay-tab" tabindex="0">...</div>
            <div class="tab-pane fade" id="calibrate-tab-pane" role="tabpanel" aria-labelledby="calibrate-tab" tabindex="0">...</div>
        </div>
    </div>

    <script>
        //   async function updateStatus() {
        //     try {
        //       const response = await fetch("/teleoperation/status");
        //       const data = await response.json();
        //       const statusDiv = document.getElementById("status");
        //       statusDiv.textContent = `Status: ${
        //         data.running ? "Running" : "Stopped"
        //       }`;
        //       statusDiv.className = data.running ? "running" : "stopped";
        //     } catch (error) {
        //       console.error("Error fetching status:", error);
        //     }
        //   }
    
          // function connectEventSource() {
          //   if (window.eventSource) {
          //     window.eventSource.close();
          //   }
    
          //   window.eventSource = new EventSource("/stream");
    
          //   window.eventSource.onmessage = function (event) {
          //     const newLine = document.createElement("div");
          //     newLine.textContent = event.data;
          //     output.appendChild(newLine);
          //     output.scrollTop = output.scrollHeight;
    
          //     if (event.data === "--- Streaming ended ---") {
          //       window.eventSource.close();
          //     }
          //   };
    
          //   window.eventSource.onerror = function (error) {
          //     console.error("SSE Error:", error);
          //     window.eventSource.close();
          //   };
          // }

          // function startStreaming() {
          //       const eventSource = new EventSource("/stream");
          //       const textArea = document.getElementById("output");

          //       eventSource.onmessage = function(event) {
          //           textArea.value += event.data + "\\n"; // Append new text
          //           textArea.scrollTop = textArea.scrollHeight; // Auto-scroll
          //       };

          //       eventSource.onerror = function() {
          //           console.log("Error occurred while streaming.");
          //           eventSource.close();
          //       };
          //   }
    
          document
            .getElementById("startTeleopBtn")
            .addEventListener("click", async () => {
              try {
                await fetch("/select_mode/teleop", { method: "GET" });
                // updateStatus();
                connectEventSource();
              } catch (error) {
                console.error("Error starting teleoperation:", error);
              }
            });
    
          document
            .getElementById("stopBtn")
            .addEventListener("click", async () => {
              try {
                await fetch("/stop", { method: "GET" });
                // updateStatus();
                // if (window.eventSource) {
                //   window.eventSource.close();
                // }
              } catch (error) {
                console.error("Error stopping teleoperation:", error);
              }
            });

            const teleopConfigForm = document.getElementById('teleopConfigForm');
            teleopConfigForm.addEventListener('submit', async (event) => {
                console.log("sending teleop config form");
                event.preventDefault(); // Prevent the default form submission
                const formData = new FormData(teleopConfigForm);
                const response = await fetch(teleopConfigForm.action, {
                    method: teleopConfigForm.method,
                    body: formData
                });
                if (response.ok) {
                    alert('Configuration Updated Successfully!');
                } else {
                    alert('Error updating configuration!');
                }
            });

            function startStreaming() {
              const eventSource = new EventSource("/stream");
              const logsDisplay = document.getElementById("logsDisplay");

              eventSource.onmessage = function(event) {

                  const newLine = document.createElement("div");
                  newLine.textContent = event.data;
                  logsDisplay.appendChild(newLine);
                  logsDisplay.scrollTop = logsDisplay.scrollHeight;

                  if (event.data === "--- Streaming ended ---") {
                    eventSource.close();
                  }
              };

              eventSource.onerror = function() {
                  console.log("Error occurred while streaming.");
                  eventSource.close();
              };
          }
    
        //   document
        //     .getElementById("recordButton")
        //     .addEventListener("click", async () => {
        //       try {
        //         output.innerHTML = "";
        //         const response = await fetch("/recording/start", {
        //           method: "POST",
        //         });
        //         const data = await response.json();
        //         console.log("Started recording:", data.recording_id);
        //         updateStatus();
        //         connectEventSource();
        //       } catch (error) {
        //         console.error("Error starting recording:", error);
        //       }
        //     });
    
        //   async function replayRecording(recordingId) {
        //     try {
        //       output.innerHTML = "";
        //       const response = await fetch(`/replay/${recordingId}`, {
        //         method: "POST",
        //       });
        //       const data = await response.json();
        //       console.log("Started replay:", data.message);
        //       updateStatus();
        //       connectEventSource();
        //     } catch (error) {
        //       console.error("Error starting replay:", error);
        //     }
        //   }
    
        //   async function updateRecordings() {
        //     try {
        //       const response = await fetch("/recordings");
        //       const recordings = await response.json();
        //       const listElement = document.getElementById("recordings");
    
        //       let html = "<h3>Available Recordings</h3>";
        //       recordings.forEach((recording) => {
        //         const date = new Date(recording.created * 1000).toLocaleString();
        //         html += `
        //           <div class="recording-item">
        //             <div class="recording-info">
        //               <strong>${recording.id}</strong><br>
        //               <small>Created: ${date}</small>
        //             </div>
        //             <button class="button replay-btn" onclick="replayRecording('${recording.id}')">
        //               Replay
        //             </button>
        //           </div>
        //         `;
        //       });
    
        //       listElement.innerHTML = html;
        //     } catch (error) {
        //       console.error("Error fetching recordings:", error);
        //     }
        //   }
    
          // Only check status periodically, remove initial EventSource connection
        //   updateStatus();
        //   setInterval(updateStatus, 2000);
        //   updateRecordings();
        //   setInterval(updateRecordings, 5000);
        startStreaming();
    </script>     

</body>
</html>