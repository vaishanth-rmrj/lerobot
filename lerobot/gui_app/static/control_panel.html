<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LeRobot | Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  </head>

  <body> 
    <div class="container-fluid d-flex justify-content-center align-items-center mt-4">
        <h1>LeRobot Control Panel</h1>
    </div>

    <div class="container p-4">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item " role="presentation">
              <button class="nav-link" id="teleop-tab" data-bs-toggle="tab" data-bs-target="#teleop-tab-pane" type="button" role="tab" aria-controls="teleop-tab-pane" aria-selected="true">Teleop</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="record-tab" data-bs-toggle="tab" data-bs-target="#record-tab-pane" type="button" role="tab" aria-controls="record-tab-pane" aria-selected="false">Record</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="replay-tab" data-bs-toggle="tab" data-bs-target="#replay-tab-pane" type="button" role="tab" aria-controls="replay-tab-pane" aria-selected="false">Replay</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="calibrate-tab" data-bs-toggle="tab" data-bs-target="#calibrate-tab-pane" type="button" role="tab" aria-controls="calibrate-tab-pane" aria-selected="false">Calibrate</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">

            <!-- teleop controls tab-->
            <div class="tab-pane fade" id="teleop-tab-pane" role="tabpanel" aria-labelledby="teleop-tab" tabindex="0">
                <div class="container">
                    <div class="row">
                        <div class="col-6">
                            <div class="container p-4">

                                <!-- teleop control buttons -->
                                <div class="card">
                                    <h5 class="card-header">Mode Controls</h5>
                                    <div class="card-body">
                                      <button class="btn btn-primary" id="startTeleopBtn">Start Teleop</button>
                                      <button class="btn btn-danger" id="stopBtn">Stop</button>

                                      <!-- toggle swtich -->
                                      <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
                                        <label class="form-check-label" for="flexSwitchCheckDefault">Display Info</label>
                                      </div>

                                    </div>
                                </div>

                                <!-- teleop configuration -->
                                <div class="accordion mt-lg-4" id="teleopAccordians">
                                  <div class="accordion-item">
                                    <h2 class="accordion-header">
                                      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                        Mode Configurations
                                      </button>
                                    </h2>
                                    <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#teleopAccordians">
                                      <div class="accordion-body">
                                        <p class="card-text">Config parameters for robot teleop</p>

                                        <!-- configs -->
                                        <form id="teleopConfigForm" action="/telop/config-update" method="post">

                                          <div class="mb-3">
                                            <label for="robotConfigSelect" class="form-label">Robot Config File</label>
                                            <select id="robotConfigSelect" class="form-select" name="robot_config">
                                              <option>lerobot/configs/robot/koch.yaml</option>
                                              <option>lerobot/configs/robot/so100.yaml</option>
                                            </select>
                                          </div>

                                          <div class="row g-3 align-items-center mb-3">
                                            <div class="col-auto">
                                              <label for="teleopFPS" class="col-form-label">FPS</label>
                                            </div>
                                            <div class="col-auto">
                                              <input type="number" id="teleopFPS" name="fps" class="form-control" aria-describedby="teleopHelpInline" value=30>
                                            </div>
                                          </div>

                                          <button type="submit" class="btn btn-primary">Apply</button>
                                        </form>

                                      </div>
                                    </div>
                                  </div>
                                  
                                  <!-- log messages -->
                                  <div class="accordion-item">
                                    <h2 class="accordion-header">
                                      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#teleopCollapseLogs" aria-expanded="true" aria-controls="teleopCollapseLogs">
                                        Logs
                                      </button>
                                    </h2>
                                    <div id="teleopCollapseLogs" class="accordion-collapse collapse" data-bs-parent="#teleopAccordians">
                                      <div class="accordion-body" id="teleopLogsDisplay" style="overflow: scroll; max-height: 500px; font-size: 12px;"></div>
                                    </div>
                                  </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-6">
                            <div class="container p-4">
                                <div class="card">
                                    <div class="card-body">
                                      <!-- <h5 class="card-title">Card title</h5> -->
                                      <p class="card-text">cam name</p>
                                      <!-- <p class="card-text"><small class="text-body-secondary">Last updated 3 mins ago</small></p> -->
                                    </div>
                                    <img src="/video/0" class="card-img-bottom" alt="" style="width: 640px; height: 480px; background: #000; border-radius: 4px;">
                                </div>

                                <div class="card">
                                    <div class="card-body">
                                      <!-- <h5 class="card-title">Card title</h5> -->
                                      <p class="card-text">cam name</p>
                                      <!-- <p class="card-text"><small class="text-body-secondary">Last updated 3 mins ago</small></p> -->
                                    </div>
                                    <img src="https://plus.unsplash.com/premium_photo-1669357657874-34944fa0be68?q=80&w=3870&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" class="card-img-bottom" alt="">
                                </div>
                            </div>                            
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- record controls tab-->
            <div class="tab-pane fade show active" id="record-tab-pane" role="tabpanel" aria-labelledby="record-tab" tabindex="1">
              <div class="container">
                <div class="row">
                    <div class="col-6">
                        <div class="container p-4">

                            <!-- record control buttons -->
                            <div class="card">
                                <h5 class="card-header">Mode Controls</h5>
                                <div class="card-body">

                                  <button class="btn btn-primary" id="startRecordSessionBtn"><i class="bi bi-arrow-repeat"></i> Start Session</button>
                                  <button class="btn btn-danger" id="stopRecordSessionBtn"><i class="bi bi-ban"></i> Stop Session</button>

                                  <hr>
                                  <div class="mt-2">

                                    <button class="btn btn-success" id="startRecordBtn"><i class="bi bi-record-fill"></i> Record</button>                                    
                                    <button class="btn btn-primary" id="finishRecordBtn"><i class="bi bi-save-fill "></i> Finish</button>
                                    <button class="btn btn-danger" id="cancelRecordBtn"><i class="bi bi-trash3-fill"></i> Cancel</button>

                                  </div>

                                  <!-- toggle switch -->
                                  <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
                                    <label class="form-check-label" for="flexSwitchCheckDefault">Display Info</label>
                                  </div>

                                </div>
                            </div>

                            <!-- record configuration -->
                            <div class="accordion mt-lg-4" id="recordAccordian">

                              <div class="accordion-item">

                                <h2 class="accordion-header">
                                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRecordTab" aria-expanded="true" aria-controls="collapseRecordTab">
                                    Recording Configurations
                                  </button>
                                </h2>

                                <div id="collapseRecordTab" class="accordion-collapse collapse" data-bs-parent="#recordAccordian">
                                  <div class="accordion-body">
                                    <p class="card-text">Config parameters for robot dataset recording</p>

                                    <!-- configs -->
                                    <form id="recordConfigForm" action="/record/config-update" method="post">

                                      <div class="mb-3">
                                        <label for="robotConfigSelect" class="form-label">Robot Config File</label>
                                        <select id="robotConfigSelect" class="form-select" name="robot_config">
                                          <option>lerobot/configs/robot/so100.yaml</option>
                                          <option>lerobot/configs/robot/koch.yaml</option>                                          
                                        </select>
                                      </div>                                                                           

                                      <div class="row g-3 align-items-center mb-3">
                                        <div class="col-auto">
                                          <label for="recordRoot" class="col-form-label">Root Dir</label>
                                        </div>
                                        <div class="col-auto">
                                          <input type="text" id="recordRoot" name="root_dir" class="form-control" aria-describedby="recordHelpline" value="data/">
                                        </div>
                                      </div>

                                      <div class="row g-3 align-items-center mb-3">
                                        <div class="col-auto">
                                          <label for="recordRepoID" class="col-form-label">Repo ID</label>
                                        </div>
                                        <div class="col-auto">
                                          <input type="text" id="recordRepoID" name="repo_id" class="form-control" aria-describedby="recordHelpline" value="default/dataset">
                                        </div>
                                      </div>

                                      <div class="row g-3 align-items-center mb-3">
                                        <div class="col-auto">
                                          <label for="recordTags" class="col-form-label">Tags</label>
                                        </div>
                                        <div class="col-auto">
                                          <input type="text" id="recordTags" name="tags" class="form-control" aria-describedby="recordHelpline" value="">
                                        </div>
                                      </div>

                                      <div class="row g-3 align-items-center mb-3">
                                        <div class="col-auto">
                                          <label for="recordSingleTask" class="col-form-label">Single Task Desc</label>
                                        </div>
                                        <div class="col-auto">
                                          <input type="text" id="recordSingleTask" name="single_task" class="form-control" aria-describedby="recordHelpline" value="">
                                        </div>
                                      </div>

                                      <div class="row g-3 align-items-center mb-3">
                                        <div class="col-auto">
                                          <label for="recordFPS" class="col-form-label">FPS</label>
                                        </div>
                                        <div class="col-auto">
                                          <input type="number" id="recordFPS" name="fps" class="form-control" aria-describedby="recordHelpline" value="30">
                                        </div>
                                      </div> 

                                      <div class="container mb-3 d-flex flex-wrap">

                                        <div class="form-check form-switch" style="margin-right: 10px;">
                                          <input class="form-check-input" name="resume" type="checkbox" role="switch" id="resumeRecordToggle">
                                          <label class="form-check-label" for="resumeRecordToggle">Resume</label>
                                        </div>
  
                                        <div class="form-check form-switch" style="margin-right: 10px;">
                                          <input class="form-check-input" name="local_files_only" type="checkbox" role="switch" id="recordLocalFilesToggle">
                                          <label class="form-check-label" for="recordLocalFilesToggle">Local Files Only</label>
                                        </div>

                                        <div class="form-check form-switch mb-3">
                                          <input class="form-check-input" name="run_compute_stats" type="checkbox" role="switch" id="recordRunComputeStats" checked>
                                          <label class="form-check-label" for="recordRunComputeStats">Run Compute Stats</label>
                                        </div>
  
                                        <div class="form-check form-switch mb-3">
                                          <input class="form-check-input" name="push_to_hub" type="checkbox" role="switch" id="recordPushToHub">
                                          <label class="form-check-label" for="recordPushToHub">Push To Hub</label>
                                        </div>

                                      </div>                                     
                                      

                                      <div class="input-group mb-3">
                                        <span class="input-group-text">Warmup Time</span>
                                        <input type="number" class="form-control" id="recordWarmupTime" name="warmup_time_s" value="10" aria-label="warmup time">
                                        <span class="input-group-text">Episode Time</span>
                                        <input type="number" class="form-control" id="recordEpisodeTime" name="episode_time_s" value="40" aria-label="episode time">
                                      </div>

                                      <div class="input-group mb-3">
                                        <span class="input-group-text">Reset Time</span>
                                        <input type="number" class="form-control" id="recordResetTime" name="reset_time_s" value="10" aria-label="reset time">
                                        <span class="input-group-text">No. Episodes</span>
                                        <input type="number" class="form-control" id="recordNumEpisodes" name="num_episodes" value="50" aria-label="number of episodes">
                                      </div>

                                      

                                      <div class="input-group mb-3">
                                        <span class="input-group-text">Image Writer Processes</span>
                                        <input type="number" class="form-control" id="recordImageWriterProcesses" name="num_image_writer_processes" value="0" aria-label="number of processes for image writer">
                                        <span class="input-group-text">Writer Threads</span>
                                        <input type="number" class="form-control" id="recordImageWriterThreads" name="num_image_writer_threads_per_camera" value="4" aria-label="number of threads for image writer">
                                      </div>


                                      <button type="submit" class="btn btn-primary">Apply</button>

                                    </form>

                                  </div>
                                </div>
                              </div>
                              
                              <!-- log messages -->
                              <div class="accordion-item">
                                <h2 class="accordion-header">
                                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#recordCollapseLogs" aria-expanded="true" aria-controls="recordCollapseLogs">
                                    Logs
                                  </button>
                                </h2>
                                <div id="recordCollapseLogs" class="accordion-collapse collapse" data-bs-parent="#recordAccordian">
                                  <div class="accordion-body" id="recordLogsDisplay" style="overflow: scroll; max-height: 500px; font-size: 12px;"></div>
                                </div>
                              </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-6">
                        <div class="container p-4">
                            <div class="card">
                                <div class="card-body">
                                  <!-- <h5 class="card-title">Card title</h5> -->
                                  <p class="card-text">cam name</p>
                                  <!-- <p class="card-text"><small class="text-body-secondary">Last updated 3 mins ago</small></p> -->
                                </div>
                                <img src="/video/0" class="card-img-bottom" alt="" style="width: 640px; height: 480px; background: #000; border-radius: 4px;">
                            </div>

                            <div class="card">
                                <div class="card-body">
                                  <!-- <h5 class="card-title">Card title</h5> -->
                                  <p class="card-text">cam name</p>
                                  <!-- <p class="card-text"><small class="text-body-secondary">Last updated 3 mins ago</small></p> -->
                                </div>
                                <img src="https://plus.unsplash.com/premium_photo-1669357657874-34944fa0be68?q=80&w=3870&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" class="card-img-bottom" alt="">
                            </div>
                        </div>                            
                    </div>
                </div>
              </div>
            </div>


            <div class="tab-pane fade" id="replay-tab-pane" role="tabpanel" aria-labelledby="replay-tab" tabindex="0">...</div>
            <div class="tab-pane fade" id="calibrate-tab-pane" role="tabpanel" aria-labelledby="calibrate-tab" tabindex="0">...</div>
        </div>
    </div>

    <script>
        //   async function updateStatus() {
        //     try {
        //       const response = await fetch("/teleoperation/status");
        //       const data = await response.json();
        //       const statusDiv = document.getElementById("status");
        //       statusDiv.textContent = `Status: ${
        //         data.running ? "Running" : "Stopped"
        //       }`;
        //       statusDiv.className = data.running ? "running" : "stopped";
        //     } catch (error) {
        //       console.error("Error fetching status:", error);
        //     }
        //   }
    
          // function connectEventSource() {
          //   if (window.eventSource) {
          //     window.eventSource.close();
          //   }
    
          //   window.eventSource = new EventSource("/stream");
    
          //   window.eventSource.onmessage = function (event) {
          //     const newLine = document.createElement("div");
          //     newLine.textContent = event.data;
          //     output.appendChild(newLine);
          //     output.scrollTop = output.scrollHeight;
    
          //     if (event.data === "--- Streaming ended ---") {
          //       window.eventSource.close();
          //     }
          //   };
    
          //   window.eventSource.onerror = function (error) {
          //     console.error("SSE Error:", error);
          //     window.eventSource.close();
          //   };
          // }

          // function startStreaming() {
          //       const eventSource = new EventSource("/stream");
          //       const textArea = document.getElementById("output");

          //       eventSource.onmessage = function(event) {
          //           textArea.value += event.data + "\\n"; // Append new text
          //           textArea.scrollTop = textArea.scrollHeight; // Auto-scroll
          //       };

          //       eventSource.onerror = function() {
          //           console.log("Error occurred while streaming.");
          //           eventSource.close();
          //       };
          //   }
    
          document
            .getElementById("startTeleopBtn")
            .addEventListener("click", async () => {
              try {
                await fetch("/select_mode/teleop", { method: "GET" });
                // updateStatus();
                // connectEventSource();
              } catch (error) {
                console.error("Error starting teleoperation:", error);
              }
            }); 
    
          document
            .getElementById("stopBtn")
            .addEventListener("click", async () => {
              try {
                await fetch("/stop", { method: "GET" });
                // updateStatus();
                // if (window.eventSource) {
                //   window.eventSource.close();
                // }
              } catch (error) {
                console.error("Error stopping teleoperation:", error);
              }
            });

          document
            .getElementById("startRecordSessionBtn")
            .addEventListener("click", async () => {
              try {
                await fetch("/select_mode/record", { method: "GET" });
                // updateStatus();
                // connectEventSource();
              } catch (error) {
                console.error("Error starting teleoperation:", error);
              }
            });
          
          document
            .getElementById("stopRecordSessionBtn")
            .addEventListener("click", async () => {
              try {
                await fetch("/stop", { method: "GET" });
                // updateStatus();
                // if (window.eventSource) {
                //   window.eventSource.close();
                // }
              } catch (error) {
                console.error("Error stopping teleoperation:", error);
              }
            });
          
          // start editing here
          document
            .getElementById("startRecordBtn")
            .addEventListener("click", async () => {
              try {
                await fetch("/record/start_recording", { method: "GET" });
              } catch (error) {
                console.error("Error starting recording:", error);
              }
            });
          
          document
            .getElementById("finishRecordBtn")
            .addEventListener("click", async () => {
              try {
                await fetch("/record/finish_recording", { method: "GET" });
              } catch (error) {
                console.error("Error finishing recording:", error);
              }
            });
          
          document
            .getElementById("cancelRecordBtn")
            .addEventListener("click", async () => {
              try {
                await fetch("/record/cancel_recording", { method: "GET" });
              } catch (error) {
                console.error("Error cancelling recording:", error);
              }
            });

            const teleopConfigForm = document.getElementById('teleopConfigForm');
            teleopConfigForm.addEventListener('submit', async (event) => {
                console.log("sending teleop config form");
                event.preventDefault(); // Prevent the default form submission
                const formData = new FormData(teleopConfigForm);
                console.log(formData);
                const response = await fetch(teleopConfigForm.action, {
                    method: teleopConfigForm.method,
                    body: formData
                });
                if (response.ok) {
                    alert('Configuration Updated Successfully!');
                } else {
                    alert('Error updating configuration!');
                }
            });

            const recordConfigForm = document.getElementById('recordConfigForm');
            recordConfigForm.addEventListener('submit', async (event) => {
                console.log("sending record config form");
                event.preventDefault(); // Prevent the default form submission
                const formData = new FormData(recordConfigForm);
                const response = await fetch(recordConfigForm.action, {
                    method: recordConfigForm.method,
                    body: formData
                });
                if (response.ok) {
                    alert('Configuration Updated Successfully!');
                } else {
                    alert('Error updating configuration!');
                }
            });

            document.addEventListener("DOMContentLoaded", async () => {
            const form = document.getElementById("recordConfigForm");

            try {
                // Fetch data from the backend
                const response = await fetch("/record/get-config");
                const data = await response.json();

                // Map backend data to form fields
                form.robotConfigSelect.value = data.robot_config;
                form.recordRoot.value = data.root;
                form.recordRepoID.value = data.repo_id;
                form.recordTags.value = data.tags;
                form.recordFPS.value = data.fps;

                // Handle switches
                form.resumeRecordToggle.checked = data.resume;
                form.recordLocalFilesToggle.checked = data.local_files_only;
                form.recordRunComputeStats.checked = data.run_compute_stats;
                form.recordPushToHub.checked = data.push_to_hub;

                // Handle time and episode inputs
                form.recordWarmupTime.value = data.warmup_time_s;
                form.recordEpisodeTime.value = data.episode_time_s;
                form.recordResetTime.value = data.reset_time_s;
                form.recordNumEpisodes.value = data.num_episodes;

                // Handle image writer settings
                form.recordImageWriterProcesses.value = data.num_image_writer_processes;
                form.recordImageWriterThreads.value = data.num_image_writer_threads_per_camera;
                form.recordSingleTask.value = data.single_task;

            } catch (error) {
                console.error("Error fetching configuration data:", error);
            }
        });

            function startStreaming() {
              const eventSource = new EventSource("/stream");
              const teleopLogsDisplay = document.getElementById("teleopLogsDisplay");
              const recordLogsDisplay = document.getElementById("recordLogsDisplay");

              eventSource.onmessage = function(event) {

                  const teleopNewLine = document.createElement("div");
                  teleopNewLine.textContent = event.data;

                  teleopLogsDisplay.appendChild(teleopNewLine);
                  teleopLogsDisplay.scrollTop = teleopLogsDisplay.scrollHeight;

                  const recordNewLine = document.createElement("div");
                  recordNewLine.textContent = event.data;

                  recordLogsDisplay.appendChild(recordNewLine);
                  recordLogsDisplay.scrollTop = recordLogsDisplay.scrollHeight;

                  if (event.data === "--- Streaming ended ---") {
                    eventSource.close();
                  }
              };

              eventSource.onerror = function() {
                  console.log("Error occurred while streaming.");
                  eventSource.close();
              };
            }
    
        //   document
        //     .getElementById("recordButton")
        //     .addEventListener("click", async () => {
        //       try {
        //         output.innerHTML = "";
        //         const response = await fetch("/recording/start", {
        //           method: "POST",
        //         });
        //         const data = await response.json();
        //         console.log("Started recording:", data.recording_id);
        //         updateStatus();
        //         connectEventSource();
        //       } catch (error) {
        //         console.error("Error starting recording:", error);
        //       }
        //     });
    
        //   async function replayRecording(recordingId) {
        //     try {
        //       output.innerHTML = "";
        //       const response = await fetch(`/replay/${recordingId}`, {
        //         method: "POST",
        //       });
        //       const data = await response.json();
        //       console.log("Started replay:", data.message);
        //       updateStatus();
        //       connectEventSource();
        //     } catch (error) {
        //       console.error("Error starting replay:", error);
        //     }
        //   }
    
        //   async function updateRecordings() {
        //     try {
        //       const response = await fetch("/recordings");
        //       const recordings = await response.json();
        //       const listElement = document.getElementById("recordings");
    
        //       let html = "<h3>Available Recordings</h3>";
        //       recordings.forEach((recording) => {
        //         const date = new Date(recording.created * 1000).toLocaleString();
        //         html += `
        //           <div class="recording-item">
        //             <div class="recording-info">
        //               <strong>${recording.id}</strong><br>
        //               <small>Created: ${date}</small>
        //             </div>
        //             <button class="button replay-btn" onclick="replayRecording('${recording.id}')">
        //               Replay
        //             </button>
        //           </div>
        //         `;
        //       });
    
        //       listElement.innerHTML = html;
        //     } catch (error) {
        //       console.error("Error fetching recordings:", error);
        //     }
        //   }
    
          // Only check status periodically, remove initial EventSource connection
        //   updateStatus();
        //   setInterval(updateStatus, 2000);
        //   updateRecordings();
        //   setInterval(updateRecordings, 5000);

        startStreaming();
    </script>     

</body>
</html>